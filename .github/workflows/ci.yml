name: CI/CD

on:
  push:
    branches: ["*"]
  pull_request:
    branches: [master]
  workflow_dispatch:

permissions:
  contents: read

jobs:
  lint:
    name: Lint
    runs-on: ubuntu-latest
    concurrency:
      group: lint-${{ github.workflow }}-${{ github.head_ref || github.ref }}
      cancel-in-progress: true
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install ruff
        run: pip install ruff

      - name: Ruff check
        run: ruff check src/ tests/ --output-format=github

      - name: Ruff format check
        run: ruff format --check --diff src/ tests/

  test:
    name: Test
    runs-on: ubuntu-latest
    needs: lint
    concurrency:
      group: test-${{ github.workflow }}-${{ github.head_ref || github.ref }}
      cancel-in-progress: true
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: pip
          cache-dependency-path: requirements-ci.txt

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements-ci.txt

      - name: Run tests
        run: pytest tests/ -v --tb=short --junitxml=test-results.xml

      - name: Upload test results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: test-results
          path: test-results.xml
          retention-days: 30

  deploy:
    name: Deploy
    runs-on: ubuntu-latest
    needs: [lint, test]
    if: github.ref == 'refs/heads/master' && github.event_name == 'push'
    environment: production
    concurrency:
      group: deploy-production
      cancel-in-progress: false
    steps:
      - name: Deploy via SSH
        uses: appleboy/ssh-action@v1
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          port: ${{ secrets.SERVER_PORT }}
          command_timeout: 10m
          script: |
            set -e

            cd ${{ secrets.DEPLOY_PATH }}

            echo "=== Git pull ==="
            git pull origin master

            echo "=== Stopping containers ==="
            docker compose down

            echo "=== Building image ==="
            docker compose build --no-cache

            echo "=== Starting containers ==="
            docker compose up -d

            echo "=== Health check ==="
            TIMEOUT=60
            ELAPSED=0
            while [ $ELAPSED -lt $TIMEOUT ]; do
              STATUS=$(docker inspect --format='{{.State.Status}}' finans-nova-bot 2>/dev/null || echo "not_found")
              if [ "$STATUS" = "running" ]; then
                echo "Container is running (${ELAPSED}s)"
                docker compose ps
                exit 0
              fi
              echo "Waiting... status=$STATUS (${ELAPSED}s)"
              sleep 5
              ELAPSED=$((ELAPSED + 5))
            done

            echo "=== Health check failed ==="
            docker compose logs --tail=50
            exit 1

      - name: Notify success
        if: success()
        run: |
          curl -s -X POST "https://api.telegram.org/bot${{ secrets.NOTIFY_TELEGRAM_TOKEN }}/sendMessage" \
            -d chat_id=${{ secrets.NOTIFY_TELEGRAM_CHAT_ID }} \
            -d parse_mode=Markdown \
            -d text="*Deploy finans-nova*%0A%0AStatus: OK%0ACommit: \`$(echo ${{ github.sha }} | cut -c1-7)\`%0AAuthor: ${{ github.actor }}%0ABranch: \`${{ github.ref_name }}\`"

      - name: Notify failure
        if: failure()
        run: |
          curl -s -X POST "https://api.telegram.org/bot${{ secrets.NOTIFY_TELEGRAM_TOKEN }}/sendMessage" \
            -d chat_id=${{ secrets.NOTIFY_TELEGRAM_CHAT_ID }} \
            -d parse_mode=Markdown \
            -d text="*Deploy finans-nova FAILED*%0A%0ACommit: \`$(echo ${{ github.sha }} | cut -c1-7)\`%0AAuthor: ${{ github.actor }}%0A[View logs](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})"
