# Finans-Nova

Telegram-бот для учёта личных финансов с голосовым вводом.

## Что это

Бот для трекинга расходов и доходов. Говоришь голосом или пишешь текст — бот распознаёт, категоризирует и сохраняет в Google Sheets. Всё автоматически.

## Стек

- Python 3.11+
- python-telegram-bot 20+
- OpenAI Whisper (локальный STT)
- YandexGPT (категоризация)
- Google Sheets API (хранение)
- matplotlib (графики)
- Docker

## Как работает

```
Голос/текст → Whisper STT → YandexGPT → подтверждение → Google Sheets
```

### Flow

1. Пользователь отправляет голосовое или текст: "такси до работы 500, кофе 250"
2. Whisper транскрибирует аудио (если голос)
3. YandexGPT парсит текст, выделяет каждую транзакцию отдельно с контекстом
4. Бот показывает распознанное и просит подтвердить
5. После подтверждения — запись в Google Sheets
6. Автоматический пересчёт баланса и сводки

### Категории

Расходы: Еда, Жильё и быт, Такси, Здоровье, Развлечения, Одежда, Подписки, Подарки, Прочее

Доходы: одна категория "Доход"

## Возможности

- Голосовой ввод через Whisper (модель medium)
- AI-категоризация через YandexGPT с fallback на ключевые слова
- Множественные транзакции в одном сообщении
- Редактирование перед сохранением (категория, сумма, описание)
- Графики: pie chart, bar chart, сравнение с прошлым месяцем
- Аналитика за произвольный период с AI-отчётом
- CSV-экспорт
- Автоотчёты по расписанию

## Структура Google Sheets

Два листа:

**Транзакции** — лог всех операций
| Дата | Время | Тип | Категория | Описание | Сумма | Баланс |

**Сводка** — агрегированные данные с формулами SUMIFS

## Установка

### Требования

- Python 3.11+
- FFmpeg (обязателен для конвертации OGG → WAV)
- Google Service Account

### Переменные окружения

```bash
cp .env.example .env
```

```
TELEGRAM_BOT_TOKEN=
YANDEX_GPT_API_KEY=
YANDEX_GPT_FOLDER_ID=
GOOGLE_SHEETS_CREDENTIALS_FILE=credentials/service_account.json
GOOGLE_SHEETS_SPREADSHEET_ID=
ALLOWED_USER_IDS=123456789,987654321
```

### Локальный запуск

```bash
pip install -r requirements.txt
python src/main.py
```

### Docker

```bash
make build
make run
make logs
make stop
```

## Структура проекта

```
src/
├── main.py              # Точка входа
├── config.py            # Конфигурация из .env
├── bot/
│   ├── handlers/        # voice, text, callbacks, menu
│   ├── keyboards.py     # Inline-кнопки
│   └── states.py        # Состояния диалога
├── services/
│   ├── speech.py        # Whisper STT
│   ├── ai_analyzer.py   # YandexGPT
│   ├── sheets.py        # Google Sheets CRUD
│   ├── charts.py        # matplotlib графики
│   └── scheduler.py     # APScheduler
├── models/
│   ├── transaction.py   # Pydantic модель
│   └── category.py      # Категории
└── utils/
    ├── audio.py         # FFmpeg конвертация
    └── formatters.py    # Форматирование
```

## Преимущества

**Голосовой ввод** — не нужно печатать, просто говоришь. Whisper работает локально, не зависит от внешних API.

**Контекстные описания** — AI понимает контекст. "такси до работы" → категория Такси, описание "До работы". "цветы жене" → категория Подарки, описание "Цветы жене".

**Множественные транзакции** — одним сообщением добавляешь несколько покупок. "обед 400, кофе 250, такси 500" — три отдельные записи.

**Google Sheets** — данные всегда доступны, можно строить свои отчёты, делиться с семьёй.

**Fallback** — если YandexGPT недоступен, категоризация работает по ключевым словам.

**Приватность** — Whisper локальный, данные только в твоём Google Sheets. Бот работает только для указанных user_id.

## Тесты

```bash
pytest tests/ -v
```

## Лицензия

MIT
